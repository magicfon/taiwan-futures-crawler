name: æ¯æ—¥å°æœŸæ‰€è³‡æ–™çˆ¬å–

on:
  schedule:
    # æ¯æ—¥å°åŒ—æ™‚é–“ 15:30 åŸ·è¡Œ (UTC 07:30)
    - cron: '30 7 * * *'
  # å…è¨±æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:
    inputs:
      date_range:
        description: 'æ—¥æœŸç¯„åœ (æ ¼å¼: YYYY-MM-DD,YYYY-MM-DD æˆ– today)'
        required: false
        default: 'today'
      contracts:
        description: 'å¥‘ç´„ä»£ç¢¼ (ç”¨é€—è™Ÿåˆ†éš”ï¼Œå¦‚: TX,TE,MTX)'
        required: false
        default: 'TX,TE,MTX,ZMX,NQF'
      retry_if_empty:
        description: 'å¦‚æœæ²’æœ‰è³‡æ–™æ˜¯å¦é‡è©¦'
        required: false
        default: 'true'
      skip_missing_check:
        description: 'è·³ééºæ¼è³‡æ–™æª¢æŸ¥'
        required: false
        default: 'false'

jobs:
  crawl-data:
    runs-on: ubuntu-latest
    
    steps:
    - name: æª¢å‡ºç¨‹å¼ç¢¼
      uses: actions/checkout@v4
      
    - name: è¨­å®šPythonç’°å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: å®‰è£ç›¸ä¾å¥—ä»¶
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: å»ºç«‹è¼¸å‡ºç›®éŒ„
      run: |
        mkdir -p output
        mkdir -p logs
        mkdir -p charts
        mkdir -p reports
        mkdir -p data
        
    - name: è¨­å®šGoogle Sheetsèªè­‰
      env:
        GOOGLE_SHEETS_CREDENTIALS: ${{ secrets.GOOGLE_SHEETS_CREDENTIALS }}
      run: |
        if [ -n "$GOOGLE_SHEETS_CREDENTIALS" ]; then
          mkdir -p config
          echo "$GOOGLE_SHEETS_CREDENTIALS" > config/google_sheets_credentials.json
          echo "âœ… Google Sheetsèªè­‰å·²è¨­å®šï¼ˆä¾†è‡ªGitHub Secretï¼‰"
        else
          echo "âš ï¸ æœªè¨­å®šGOOGLE_SHEETS_CREDENTIALS Secretï¼Œè·³éGoogle SheetsåŠŸèƒ½"
        fi
        
    - name: è¨­å®šTelegramé€šçŸ¥
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        if [ -n "$TELEGRAM_BOT_TOKEN" ] && [ -n "$TELEGRAM_CHAT_ID" ]; then
          echo "âœ… Telegramé€šçŸ¥å·²è¨­å®šï¼ˆä¾†è‡ªGitHub Secretsï¼‰"
          # å°å‡ºç’°å¢ƒè®Šæ•¸ä¾›å¾ŒçºŒæ­¥é©Ÿä½¿ç”¨
          echo "TELEGRAM_BOT_TOKEN=$TELEGRAM_BOT_TOKEN" >> $GITHUB_ENV
          echo "TELEGRAM_CHAT_ID=$TELEGRAM_CHAT_ID" >> $GITHUB_ENV
        else
          echo "âš ï¸ æœªè¨­å®šTelegram Secretsï¼Œè·³éTelegramé€šçŸ¥åŠŸèƒ½"
        fi
        
    - name: æ™‚é–“èª¿è©¦æª¢æŸ¥
      run: |
        echo "ğŸ• æª¢æŸ¥ç³»çµ±æ™‚é–“è¨­å®š..."
        python debug_time.py
        echo ""
        echo "ç³»çµ±æŒ‡ä»¤æª¢æŸ¥:"
        date
        echo "UTCæ™‚é–“: $(date -u)"
        
    - name: æª¢æŸ¥ä¸¦è£œé½Šéºæ¼è³‡æ–™
      id: missing_check
      if: github.event.inputs.skip_missing_check != 'true'
      run: |
        echo "ğŸ” é–‹å§‹æª¢æŸ¥è¿‘30å¤©éºæ¼çš„äº¤æ˜“æ—¥è³‡æ–™..."
        
        # åŸ·è¡Œéºæ¼è³‡æ–™æª¢æŸ¥å’Œè£œé½Š
        python check_and_fill_missing_data.py --days 30
        
        # æª¢æŸ¥åŸ·è¡Œçµæœ
        if [ $? -eq 0 ]; then
          echo "âœ… éºæ¼è³‡æ–™æª¢æŸ¥å’Œè£œé½Šå®Œæˆ"
          echo "success=true" >> $GITHUB_OUTPUT
        else
          echo "âš ï¸ éºæ¼è³‡æ–™æª¢æŸ¥éç¨‹ä¸­æœ‰è­¦å‘Šï¼Œä½†ç¹¼çºŒåŸ·è¡Œ"
          echo "success=false" >> $GITHUB_OUTPUT
        fi
        
        # é¡¯ç¤ºæª¢æŸ¥å ±å‘Š
        if [ -f "reports/missing_data_check_report.json" ]; then
          echo "ğŸ“‹ æª¢æŸ¥å ±å‘Šæ‘˜è¦:"
          cat reports/missing_data_check_report.json
        fi
        
        # é¡¯ç¤ºæª¢æŸ¥æ—¥èªŒ
        if [ -f "missing_data_check.log" ]; then
          echo ""
          echo "ğŸ“„ æª¢æŸ¥æ—¥èªŒ (æœ€å¾Œ20è¡Œ):"
          tail -20 missing_data_check.log
        fi
        
    - name: åŸ·è¡Œçˆ¬èŸ² (ç¬¬ä¸€æ¬¡å˜—è©¦)
      id: first_attempt
      run: |
        echo "ğŸš€ é–‹å§‹ç¬¬ä¸€æ¬¡çˆ¬å–å˜—è©¦..."
        
        if [ "${{ github.event.inputs.date_range }}" = "today" ] || [ -z "${{ github.event.inputs.date_range }}" ]; then
          # åŸ·è¡Œä»Šæ—¥è³‡æ–™çˆ¬å–
          python taifex_crawler.py --date-range today --contracts ${{ github.event.inputs.contracts || 'TX,TE,MTX' }}
        else
          # åŸ·è¡ŒæŒ‡å®šæ—¥æœŸç¯„åœçˆ¬å–
          python taifex_crawler.py --date-range "${{ github.event.inputs.date_range }}" --contracts ${{ github.event.inputs.contracts || 'TX,TE,MTX' }}
        fi
        
        # æª¢æŸ¥æ˜¯å¦æœ‰ç”¢ç”Ÿè¼¸å‡ºæª”æ¡ˆ
        if [ "$(ls -A output/ 2>/dev/null)" ]; then
          echo "âœ… ç¬¬ä¸€æ¬¡çˆ¬å–æˆåŠŸï¼Œæœ‰ç”¢ç”Ÿè³‡æ–™æª”æ¡ˆ"
          echo "success=true" >> $GITHUB_OUTPUT
        else
          echo "âš ï¸ ç¬¬ä¸€æ¬¡çˆ¬å–æ²’æœ‰ç”¢ç”Ÿè³‡æ–™æª”æ¡ˆ"
          echo "success=false" >> $GITHUB_OUTPUT
        fi
        
    - name: ç­‰å¾…é‡è©¦ (å¦‚æœç¬¬ä¸€æ¬¡å¤±æ•—)
      if: steps.first_attempt.outputs.success == 'false' && (github.event.inputs.retry_if_empty == 'true' || github.event_name == 'schedule')
      run: |
        echo "ğŸ˜´ ç­‰å¾…10åˆ†é˜å¾Œé‡è©¦..."
        sleep 600  # ç­‰å¾…10åˆ†é˜ (600ç§’)
        
    - name: åŸ·è¡Œçˆ¬èŸ² (é‡è©¦)
      id: retry_attempt
      if: steps.first_attempt.outputs.success == 'false' && (github.event.inputs.retry_if_empty == 'true' || github.event_name == 'schedule')
      run: |
        echo "ğŸ”„ é–‹å§‹é‡è©¦çˆ¬å–..."
        
        if [ "${{ github.event.inputs.date_range }}" = "today" ] || [ -z "${{ github.event.inputs.date_range }}" ]; then
          # åŸ·è¡Œä»Šæ—¥è³‡æ–™çˆ¬å–
          python taifex_crawler.py --date-range today --contracts ${{ github.event.inputs.contracts || 'TX,TE,MTX' }}
        else
          # åŸ·è¡ŒæŒ‡å®šæ—¥æœŸç¯„åœçˆ¬å–
          python taifex_crawler.py --date-range "${{ github.event.inputs.date_range }}" --contracts ${{ github.event.inputs.contracts || 'TX,TE,MTX' }}
        fi
        
        # æª¢æŸ¥æ˜¯å¦æœ‰ç”¢ç”Ÿè¼¸å‡ºæª”æ¡ˆ
        if [ "$(ls -A output/ 2>/dev/null)" ]; then
          echo "âœ… é‡è©¦çˆ¬å–æˆåŠŸï¼Œæœ‰ç”¢ç”Ÿè³‡æ–™æª”æ¡ˆ"
          echo "success=true" >> $GITHUB_OUTPUT
        else
          echo "âŒ é‡è©¦å¾Œä»ç„¶æ²’æœ‰è³‡æ–™æª”æ¡ˆ"
          echo "success=false" >> $GITHUB_OUTPUT
        fi

    - name: ç”Ÿæˆ30å¤©è³‡æ–™åœ–è¡¨å’Œå ±å‘Š
      if: steps.first_attempt.outputs.success == 'true' || steps.retry_attempt.outputs.success == 'true'
      run: |
        echo "ğŸ“Š é–‹å§‹ç”Ÿæˆ30å¤©è³‡æ–™åœ–è¡¨å’Œå ±å‘Š..."
        
        # å˜—è©¦ç”Ÿæˆåœ–è¡¨å ±å‘Š
        if [ -f "daily_report_generator.py" ]; then
          python daily_report_generator.py --days 30 --output charts/ || echo "âš ï¸ åœ–è¡¨ç”Ÿæˆå¤±æ•—ï¼Œä½†ç¹¼çºŒåŸ·è¡Œ"
        fi
        
        # å˜—è©¦ç”ŸæˆTelegramå ±å‘Š
        if [ -n "$TELEGRAM_BOT_TOKEN" ] && [ -n "$TELEGRAM_CHAT_ID" ]; then
          if [ -f "test_telegram_report.py" ]; then
            python test_telegram_report.py || echo "âš ï¸ Telegramå ±å‘Šç™¼é€å¤±æ•—"
          fi
        fi
        
    - name: æª¢æŸ¥æœ€çµ‚çµæœ
      run: |
        FIRST_SUCCESS="${{ steps.first_attempt.outputs.success }}"
        RETRY_SUCCESS="${{ steps.retry_attempt.outputs.success }}"
        MISSING_CHECK="${{ steps.missing_check.outputs.success }}"
        
        echo "=== åŸ·è¡Œçµæœæ‘˜è¦ ==="
        echo "éºæ¼è³‡æ–™æª¢æŸ¥: $MISSING_CHECK"
        echo "ç¬¬ä¸€æ¬¡çˆ¬å–: $FIRST_SUCCESS"
        if [ "$FIRST_SUCCESS" = "false" ]; then
          echo "é‡è©¦çµæœ: $RETRY_SUCCESS"
        fi
        
        echo ""
        echo "=== è¼¸å‡ºç›®éŒ„å…§å®¹ ==="
        ls -la output/ || echo "è¼¸å‡ºç›®éŒ„ç‚ºç©º"
        
        echo ""
        echo "=== åœ–è¡¨ç›®éŒ„å…§å®¹ ==="
        ls -la charts/ || echo "åœ–è¡¨ç›®éŒ„ç‚ºç©º"
        
        echo ""
        echo "=== å ±å‘Šç›®éŒ„å…§å®¹ ==="
        ls -la reports/ || echo "å ±å‘Šç›®éŒ„ç‚ºç©º"
        
        echo ""
        echo "=== è³‡æ–™åº«æª”æ¡ˆ ==="
        if [ -d "data" ]; then
          ls -la data/
        fi
        
        echo ""
        echo "=== æ—¥èªŒå…§å®¹ (æœ€å¾Œ50è¡Œ) ==="
        if [ -f taifex_crawler.log ]; then
          tail -50 taifex_crawler.log
        fi
        
        # è¨­å®šå¤±æ•—ç‹€æ…‹ (å¦‚æœå…©æ¬¡éƒ½å¤±æ•—)
        if [ "$FIRST_SUCCESS" = "false" ] && [ "$RETRY_SUCCESS" = "false" ]; then
          echo "âŒ å…©æ¬¡çˆ¬å–éƒ½å¤±æ•—ï¼Œè«‹æª¢æŸ¥å°æœŸæ‰€ç¶²ç«™ç‹€æ…‹"
          exit 1
        fi
        
    - name: è¨­å®šGitä½¿ç”¨è€…
      run: |
        git config --global user.name 'GitHub Actions Bot'
        git config --global user.email 'actions@github.com'
        
    - name: æäº¤å›ºå®šè³‡æ–™æª”æ¡ˆ
      run: |
        # æª¢æŸ¥æ˜¯å¦æœ‰é‡è¦çš„å›ºå®šæª”æ¡ˆéœ€è¦æäº¤
        # æ³¨æ„ï¼šæŸäº›æª”æ¡ˆå¯èƒ½è¢«.gitignoreå¿½ç•¥ï¼Œéœ€è¦ç‰¹åˆ¥è™•ç†
        
        HAS_CHANGES=false
        
        echo "ğŸ” æª¢æŸ¥éœ€è¦æäº¤çš„é‡è¦æª”æ¡ˆ..."
        
        # 1. æª¢æŸ¥æœ€æ–°30å¤©è³‡æ–™æª”æ¡ˆ
        if [ -f "output/å°æœŸæ‰€æœ€æ–°30å¤©è³‡æ–™.xlsx" ]; then
          # ç”±æ–¼output/*.xlsxè¢«å¿½ç•¥ï¼Œæˆ‘å€‘å‰µå»ºä¸€å€‹ç‰¹æ®Šçš„æª”æ¡ˆå
          cp "output/å°æœŸæ‰€æœ€æ–°30å¤©è³‡æ–™.xlsx" "latest_30days_data.xlsx" || echo "âš ï¸ è¤‡è£½30å¤©è³‡æ–™æª”æ¡ˆå¤±æ•—"
          if [ -f "latest_30days_data.xlsx" ]; then
            git add "latest_30days_data.xlsx" || echo "âš ï¸ æ·»åŠ 30å¤©è³‡æ–™æª”æ¡ˆå¤±æ•—"
            echo "âœ… å·²æ·»åŠ : latest_30days_data.xlsx (ä¾†è‡ªoutput/å°æœŸæ‰€æœ€æ–°30å¤©è³‡æ–™.xlsx)"
            HAS_CHANGES=true
          fi
        fi
        
        # 2. æª¢æŸ¥éºæ¼è³‡æ–™æª¢æŸ¥å ±å‘Šï¼ˆç¾åœ¨.gitignoreå…è¨±é€™å€‹æª”æ¡ˆï¼‰
        if [ -f "reports/missing_data_check_report.json" ]; then
          # ç¢ºä¿reportsç›®éŒ„å­˜åœ¨ä¸”å¯å¯«
          mkdir -p reports || echo "âš ï¸ ç„¡æ³•å‰µå»ºreportsç›®éŒ„"
          if git add "reports/missing_data_check_report.json" 2>/dev/null; then
            echo "âœ… å·²æ·»åŠ : reports/missing_data_check_report.json"
            HAS_CHANGES=true
          else
            echo "âš ï¸ ç„¡æ³•æ·»åŠ éºæ¼è³‡æ–™æª¢æŸ¥å ±å‘Šï¼Œå¯èƒ½è¢«.gitignoreå¿½ç•¥"
            # ä½œç‚ºå¾Œå‚™æ–¹æ¡ˆï¼Œè¤‡è£½åˆ°æ ¹ç›®éŒ„
            cp "reports/missing_data_check_report.json" "missing_data_report.json" 2>/dev/null || echo "âš ï¸ è¤‡è£½å ±å‘Šæª”æ¡ˆå¤±æ•—"
            if [ -f "missing_data_report.json" ]; then
              git add "missing_data_report.json" || echo "âš ï¸ æ·»åŠ å‚™ç”¨å ±å‘Šæª”æ¡ˆå¤±æ•—"
              echo "âœ… å·²æ·»åŠ : missing_data_report.json (å‚™ç”¨)"
              HAS_CHANGES=true
            fi
          fi
        fi
        
        # 3. æª¢æŸ¥æ—¥èªŒæª”æ¡ˆ (é€šå¸¸è¢«å¿½ç•¥ï¼Œä½†æˆ‘å€‘å¯ä»¥å‰µå»ºæ‘˜è¦)
        if [ -f "taifex_crawler.log" ]; then
          # å‰µå»ºæ—¥èªŒæ‘˜è¦è€Œä¸æ˜¯æ•´å€‹æ—¥èªŒæª”æ¡ˆ
          echo "=== æœ€å¾ŒåŸ·è¡Œæ‘˜è¦ ===" > execution_summary.txt
          echo "åŸ·è¡Œæ™‚é–“: $(date)" >> execution_summary.txt
          echo "éºæ¼è³‡æ–™æª¢æŸ¥: ${{ steps.missing_check.outputs.success }}" >> execution_summary.txt
          echo "ç¬¬ä¸€æ¬¡çˆ¬å–: ${{ steps.first_attempt.outputs.success }}" >> execution_summary.txt
          echo "é‡è©¦çµæœ: ${{ steps.retry_attempt.outputs.success }}" >> execution_summary.txt
          echo "" >> execution_summary.txt
          echo "=== æ—¥èªŒæœ€å¾Œ20è¡Œ ===" >> execution_summary.txt
          tail -20 taifex_crawler.log >> execution_summary.txt 2>/dev/null || echo "ç„¡æ³•è®€å–æ—¥èªŒå…§å®¹" >> execution_summary.txt
          git add execution_summary.txt || echo "âš ï¸ æ·»åŠ åŸ·è¡Œæ‘˜è¦å¤±æ•—"
          echo "âœ… å·²æ·»åŠ : execution_summary.txt"
          HAS_CHANGES=true
        fi
        
        # 4. å…¶ä»–ä¸è¢«å¿½ç•¥çš„é‡è¦æª”æ¡ˆ
        if [ -f "config/spreadsheet_config.json" ]; then
          if git add "config/spreadsheet_config.json" 2>/dev/null; then
            echo "âœ… å·²æ·»åŠ : config/spreadsheet_config.json"
            HAS_CHANGES=true
          else
            echo "âš ï¸ ç„¡æ³•æ·»åŠ spreadsheet_config.json"
          fi
        fi
        
        # 5. é¡¯ç¤ºå¯¦éš›å°‡è¦æäº¤çš„æª”æ¡ˆ
        echo ""
        echo "ğŸ“‹ å°‡è¦æäº¤çš„æª”æ¡ˆï¼š"
        git diff --cached --name-only 2>/dev/null || echo "æ²’æœ‰æš«å­˜çš„æª”æ¡ˆ"
        
        # æäº¤è®Šæ›´
        if [ "$HAS_CHANGES" = true ]; then
          echo ""
          echo "ğŸ’¾ æ­£åœ¨æäº¤è®Šæ›´..."
          if git commit -m "ğŸ¤– è‡ªå‹•æ›´æ–°: $(date '+%Y-%m-%d %H:%M:%S') å°æœŸæ‰€è³‡æ–™å’ŒåŸ·è¡Œæ‘˜è¦" 2>/dev/null; then
            echo "âœ… æäº¤æˆåŠŸ"
          else
            echo "âš ï¸ æäº¤å¤±æ•—æˆ–æ²’æœ‰è®Šæ›´éœ€è¦æäº¤"
          fi
        else
          echo "ğŸ“ æ²’æœ‰é‡è¦æª”æ¡ˆéœ€è¦æäº¤"
        fi
        
    - name: æ¨é€æ›´æ–°
      run: |
        # æª¢æŸ¥æ˜¯å¦æœ‰å¾…æ¨é€çš„æäº¤
        if git diff --quiet HEAD~1 HEAD 2>/dev/null; then
          echo "æ²’æœ‰æ–°çš„æäº¤éœ€è¦æ¨é€"
        else
          git push || echo "æ¨é€å¤±æ•—ï¼Œå¯èƒ½æ²’æœ‰è®Šæ›´"
        fi
        
    - name: ä¸Šå‚³åŸ·è¡Œæ—¥èªŒå’Œå ±å‘Š
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: crawler-logs-and-reports-${{ github.run_number }}
        path: |
          taifex_crawler.log
          missing_data_check.log
          output/
          charts/
          reports/
        retention-days: 30 