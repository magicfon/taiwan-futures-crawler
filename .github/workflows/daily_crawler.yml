name: æ¯æ—¥å°æœŸæ‰€è³‡æ–™çˆ¬å–

on:
  schedule:
    # æ¯æ—¥å°åŒ—æ™‚é–“ 09:00 åŸ·è¡Œ (UTC 01:00)
    - cron: '0 1 * * *'
  # å…è¨±æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:
    inputs:
      date_range:
        description: 'æ—¥æœŸç¯„åœ (æ ¼å¼: YYYY-MM-DD,YYYY-MM-DD æˆ– today)'
        required: false
        default: 'today'
      contracts:
        description: 'å¥‘ç´„ä»£ç¢¼ (ç”¨é€—è™Ÿåˆ†éš”ï¼Œå¦‚: TX,TE,MTX)'
        required: false
        default: 'TX,TE,MTX,ZMX,NQF'

jobs:
  crawl-data:
    runs-on: ubuntu-latest
    
    steps:
    - name: æª¢å‡ºç¨‹å¼ç¢¼
      uses: actions/checkout@v4
      
    - name: è¨­å®šPythonç’°å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: å®‰è£ç›¸ä¾å¥—ä»¶
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: å»ºç«‹è¼¸å‡ºç›®éŒ„
      run: |
        mkdir -p output
        mkdir -p logs
        
    - name: åŸ·è¡Œçˆ¬èŸ²
      run: |
        if [ "${{ github.event.inputs.date_range }}" = "today" ] || [ -z "${{ github.event.inputs.date_range }}" ]; then
          # åŸ·è¡Œä»Šæ—¥è³‡æ–™çˆ¬å–
          python taifex_crawler.py --date-range today --contracts ${{ github.event.inputs.contracts || 'TX,TE,MTX' }}
        else
          # åŸ·è¡ŒæŒ‡å®šæ—¥æœŸç¯„åœçˆ¬å–
          python taifex_crawler.py --date-range "${{ github.event.inputs.date_range }}" --contracts ${{ github.event.inputs.contracts || 'TX,TE,MTX' }}
        fi
        
    - name: æª¢æŸ¥è¼¸å‡ºæ–‡ä»¶
      run: |
        echo "=== è¼¸å‡ºç›®éŒ„å…§å®¹ ==="
        ls -la output/
        echo ""
        echo "=== è³‡æ–™åº«æª”æ¡ˆ ==="
        if [ -d "data" ]; then
          ls -la data/
        fi
        echo ""
        echo "=== å ±å‘Šæª”æ¡ˆ ==="
        if [ -d "reports" ]; then
          ls -la reports/
        fi
        echo ""
        echo "=== æ—¥èªŒå…§å®¹ (æœ€å¾Œ50è¡Œ) ==="
        if [ -f taifex_crawler.log ]; then
          tail -50 taifex_crawler.log
        fi
        
    - name: æäº¤å›ºå®šè³‡æ–™æª”æ¡ˆ
      run: |
        # æª¢æŸ¥æ˜¯å¦æœ‰é‡è¦çš„å›ºå®šæª”æ¡ˆéœ€è¦æäº¤
        IMPORTANT_FILES=(
          "output/å°æœŸæ‰€æœ€æ–°30å¤©è³‡æ–™.xlsx"
          "data/taifex_data.db"
        )
        
        HAS_CHANGES=false
        
        # æª¢æŸ¥æ¯å€‹é‡è¦æª”æ¡ˆ
        for file in "${IMPORTANT_FILES[@]}"; do
          if [ -f "$file" ]; then
            git add "$file"
            echo "å·²æ·»åŠ : $file"
            HAS_CHANGES=true
          fi
        done
        
        # æ·»åŠ å ±å‘Šæª”æ¡ˆ
        if [ -d "reports" ]; then
          git add reports/
          echo "å·²æ·»åŠ å ±å‘Šç›®éŒ„"
          HAS_CHANGES=true
        fi
        
        # æ·»åŠ æ—¥èªŒ
        if [ -f taifex_crawler.log ]; then
          git add taifex_crawler.log
          HAS_CHANGES=true
        fi
        
        # æäº¤è®Šæ›´
        if [ "$HAS_CHANGES" = true ]; then
          git commit -m "ğŸ¤– è‡ªå‹•æ›´æ–°: $(date '+%Y-%m-%d %H:%M:%S') å°æœŸæ‰€è³‡æ–™å’Œåˆ†æå ±å‘Š" || echo "æ²’æœ‰éœ€è¦æäº¤çš„è®Šæ›´"
        else
          echo "æ²’æœ‰é‡è¦æª”æ¡ˆéœ€è¦æäº¤"
        fi
    
    - name: è¨­å®šGitä½¿ç”¨è€…
      run: |
        git config --global user.name 'GitHub Actions Bot'
        git config --global user.email 'actions@github.com'
        
    - name: æ¨é€æ›´æ–°
      run: |
        # æª¢æŸ¥æ˜¯å¦æœ‰å¾…æ¨é€çš„æäº¤
        if git diff --quiet HEAD~1 HEAD 2>/dev/null; then
          echo "æ²’æœ‰æ–°çš„æäº¤éœ€è¦æ¨é€"
        else
          git push || echo "æ¨é€å¤±æ•—ï¼Œå¯èƒ½æ²’æœ‰è®Šæ›´"
        fi
        
    - name: ä¸Šå‚³åŸ·è¡Œæ—¥èªŒ
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: crawler-logs-${{ github.run_number }}
        path: |
          taifex_crawler.log
          output/
        retention-days: 30 