name: âš¡ æ‰‹å‹•åŸ·è¡Œå°æœŸæ‰€è³‡æ–™çˆ¬å–

on:
  workflow_dispatch:
    inputs:
      data_type:
        description: 'è³‡æ–™é¡žåž‹'
        required: true
        default: 'COMPLETE'
        type: choice
        options:
          - 'TRADING'
          - 'COMPLETE'
      contracts:
        description: 'å¥‘ç´„ä»£ç¢¼ (ç”¨é€—è™Ÿåˆ†éš”)'
        required: true
        default: 'TX,TE,MTX'
        type: string
      date_range:
        description: 'æ—¥æœŸç¯„åœ'
        required: true
        default: 'today'
        type: choice
        options:
          - 'today'
          - 'yesterday'
          - 'custom'
      custom_date:
        description: 'è‡ªè¨‚æ—¥æœŸ (YYYY-MM-DD)'
        required: false
        default: ''
        type: string

jobs:
  manual-crawl:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ”„ æª¢å‡ºç¨‹å¼ç¢¼
      uses: actions/checkout@v4
    
    - name: ðŸ è¨­å®šPythonç’°å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        cache: 'pip'
    
    - name: ðŸ“¦ å®‰è£ç›¸ä¾å¥—ä»¶
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: ðŸ• é¡¯ç¤ºåŸ·è¡Œè³‡è¨Š
      run: |
        echo "ðŸš€ æ‰‹å‹•åŸ·è¡Œå°æœŸæ‰€è³‡æ–™çˆ¬å–"
        echo "UTCæ™‚é–“: $(date -u)"
        echo "å°ç£æ™‚é–“: $(TZ='Asia/Taipei' date)"
        echo "è³‡æ–™é¡žåž‹: ${{ inputs.data_type }}"
        echo "å¥‘ç´„ä»£ç¢¼: ${{ inputs.contracts }}"
        echo "æ—¥æœŸç¯„åœ: ${{ inputs.date_range }}"
        if [ "${{ inputs.custom_date }}" != "" ]; then
          echo "è‡ªè¨‚æ—¥æœŸ: ${{ inputs.custom_date }}"
        fi
    
    - name: ðŸ“Š åŸ·è¡Œè³‡æ–™çˆ¬å–
      env:
        GOOGLE_SHEETS_CREDENTIALS: ${{ secrets.GOOGLE_SHEETS_CREDENTIALS }}
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        # æ±ºå®šæ—¥æœŸåƒæ•¸
        if [ "${{ inputs.date_range }}" = "custom" ] && [ "${{ inputs.custom_date }}" != "" ]; then
          DATE_PARAM="${{ inputs.custom_date }}"
        elif [ "${{ inputs.date_range }}" = "yesterday" ]; then
          DATE_PARAM="$(TZ='Asia/Taipei' date -d 'yesterday' +%Y-%m-%d)"
        else
          DATE_PARAM="today"
        fi
        
        echo "ä½¿ç”¨æ—¥æœŸåƒæ•¸: $DATE_PARAM"
        
        # åŸ·è¡Œçˆ¬èŸ²
        python taifex_crawler.py \
          --date-range "$DATE_PARAM" \
          --contracts "${{ inputs.contracts }}" \
          --identities ALL \
          --data_type "${{ inputs.data_type }}" \
          --max_workers 5 \
          --delay 1.0
    
    - name: ðŸ“ ä¸Šå‚³çˆ¬å–çµæžœ
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: manual-crawl-results-${{ inputs.data_type }}-${{ github.run_number }}
        path: |
          output/*.csv
          output/*.xlsx
          charts/*.png
          *.log
        retention-days: 30
    
    - name: ðŸ’¬ åŸ·è¡Œçµæžœæ‘˜è¦
      if: always()
      run: |
        echo "## ðŸŽ¯ åŸ·è¡Œçµæžœæ‘˜è¦" >> $GITHUB_STEP_SUMMARY
        echo "- **è³‡æ–™é¡žåž‹**: ${{ inputs.data_type }}" >> $GITHUB_STEP_SUMMARY
        echo "- **å¥‘ç´„ä»£ç¢¼**: ${{ inputs.contracts }}" >> $GITHUB_STEP_SUMMARY
        echo "- **åŸ·è¡Œæ™‚é–“**: $(TZ='Asia/Taipei' date)" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ job.status }}" = "success" ]; then
          echo "- **åŸ·è¡Œç‹€æ…‹**: âœ… æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          if [ "${{ inputs.data_type }}" = "TRADING" ]; then
            echo "- **çµæžœ**: äº¤æ˜“é‡è³‡æ–™å·²ä¸Šå‚³åˆ°Google Sheetsã€Œäº¤æ˜“é‡è³‡æ–™ã€åˆ†é " >> $GITHUB_STEP_SUMMARY
          else
            echo "- **çµæžœ**: å®Œæ•´è³‡æ–™å·²ä¸Šå‚³åˆ°Google Sheetsã€Œå®Œæ•´è³‡æ–™ã€åˆ†é " >> $GITHUB_STEP_SUMMARY
            echo "- **åœ–è¡¨**: å·²ç”Ÿæˆä¸¦ç™¼é€åˆ°Telegram" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "- **åŸ·è¡Œç‹€æ…‹**: âŒ å¤±æ•—" >> $GITHUB_STEP_SUMMARY
          echo "- **å»ºè­°**: è«‹æª¢æŸ¥Artifactsä¸­çš„æ—¥èªŒæª”æ¡ˆ" >> $GITHUB_STEP_SUMMARY
        fi 