# 台灣期貨交易所資料爬取工具

## 概述
本工具提供兩個版本來爬取台灣期貨交易所的期貨契約交易量和未平倉量資料：
1. **Google Apps Script 版本** (Code.gs) - 適合定期自動爬取
2. **Python 版本** (taifex_crawler.py) - 適合大量歷史資料爬取

## 🆕 新功能：批次爬取和執行時間管理

為了解決 Google Apps Script 執行時間限制的問題，我們添加了以下新功能：

### 批次爬取功能
- **批次爬取歷史資料**：自動分批處理大範圍日期，避免執行時間超限
- **斷點續傳**：如果執行中斷，可以從上次停止的地方繼續
- **進度追蹤**：實時保存爬取進度，隨時查看當前狀態

### 執行時間管理
- **智能時間監控**：自動監控執行時間，預留緩衝時間避免超時
- **批次大小控制**：可調整每批處理的資料量
- **自動暫停機制**：接近時間限制時自動暫停並保存進度

## 支援的期貨契約
- **TX** - 臺股期貨
- **TE** - 電子期貨  
- **MTX** - 小型臺指期貨
- **ZMX** - 微型臺指期貨
- **NQF** - 美國那斯達克100期貨

## Google Apps Script 版本

### 功能列表

#### 基本爬取功能
- **🚀 快速爬取今日資料** - 專為單日爬取優化，減少執行時間
- **爬取今日資料** - 爬取當天的期貨資料
- **爬取特定日期資料** - 爬取指定日期的資料
- **爬取歷史資料** - 爬取指定範圍的歷史資料（建議小範圍）

#### 🆕 批次爬取功能
- **批次爬取歷史資料** - 智能分批處理大範圍歷史資料
- **繼續未完成的批次爬取** - 從上次中斷處繼續爬取
- **重試失敗的爬取項目** - 自動識別並重新嘗試失敗的項目
- **查看批次進度** - 檢查當前批次爬取的進度狀態
- **清除批次進度** - 手動清除進度記錄

#### 多身份別資料爬取
- **爬取多身份別資料** - 爬取自營商、投信、外資的資料
- **爬取歷史多身份別資料** - 爬取歷史多身份別資料
- **🆕 批次爬取多身份別資料** - 分批處理多身份別歷史資料
  - 支援所有契約或指定契約
  - 自動處理三種身份別：自營商、投信、外資
  - 智能時間管理和失敗處理
  - 詳細的成功/失敗統計

#### 自動化功能
- **設置每日自動爬取** - 設定每天自動執行爬取（含失敗重試和通知）
  - ⏰ 每天下午 3:30 自動執行
  - 🔄 智能失敗重試：最多3次，間隔10分鐘
  - 📱 雙重通知服務：支援 Telegram 和 LINE Notify
  - 📊 自動數據摘要：交易量和淨額統計
- **移除每日自動爬取** - 取消自動爬取設定（含清除重試計劃）

#### 📱 通知服務設定

##### Telegram Bot 設定
1. 與 @BotFather 對話建立新的 Bot
2. 獲取 Bot Token
3. 將 Bot Token 填入 `TELEGRAM_BOT_TOKEN` 變數
4. 獲取您的 Chat ID（可透過 @userinfobot）
5. 將 Chat ID 填入 `TELEGRAM_CHAT_ID` 變數

##### LINE Notify 設定
1. 前往 [LINE Notify](https://notify-bot.line.me/) 官網
2. 登入您的 LINE 帳號
3. 發行新的權杖（Token）
4. 選擇要接收通知的群組或個人聊天
5. 將權杖填入 `LINE_NOTIFY_TOKEN` 變數

**💡 通知費用說明**：
- **LINE Notify**：完全免費，每小時最多1000則訊息
- **Telegram Bot**：完全免費，無訊息限制
- 兩種服務都可以同時使用，系統會自動發送到所有已設定的服務

**📋 通知內容包含**：
- ✅ 成功爬取的契約和筆數
- ❌ 失敗項目的詳細列表
- 🔄 重試次數和狀態
- 📊 交易量和淨額數據摘要
- ⚠️ 系統錯誤和建議處理方式

#### 圖表和分析
- **創建期貨交易圖表** - 生成交易量和未平倉量圖表
- **各契約快速圖表** - 快速生成指定契約的30天圖表

### 📋 使用建議

#### 🚀 快速單日爬取
如果遇到「即使只爬一天也會執行時間已達上限」的問題：
- 使用「**快速爬取今日資料**」功能
- 該功能已針對單日爬取進行以下優化：
  - 減少參數嘗試次數
  - 簡化日誌記錄
  - 最小化延遲時間
  - 添加請求超時控制

#### 小範圍資料（1-30天）
使用基本爬取功能：
- 爬取歷史資料
- 爬取歷史多身份別資料

#### 大範圍資料（超過30天）
使用批次爬取功能：
- **批次爬取歷史資料** - 避免執行時間超限
- **批次爬取多身份別資料** - 分批處理身份別資料

#### 🏢 身份別資料爬取
專門針對投信、自營商、外資資料：
- **單日身份別**：使用「爬取多身份別資料」
- **歷史身份別**：使用「批次爬取多身份別資料」
- **特定契約**：可選擇單一契約或所有契約
- **預設行為**：如果沒有輸入契約名稱（留空），系統會自動爬取所有契約（ALL）
- **失敗重試**：「重試失敗的爬取項目」支援身份別資料

#### 執行中斷時
- 使用「繼續未完成的批次爬取」恢復
- 使用「查看批次進度」檢查狀態

#### 📊 失敗處理最佳實踐
當批次爬取完成但有失敗項目時：
1. **檢查失敗原因**：查看「爬取記錄」工作表了解失敗詳情
2. **重試失敗項目**：使用「重試失敗的爬取項目」功能
3. **保留記錄**：系統會自動保留批次進度供後續分析
4. **手動清除**：確認無需重試後，可手動「清除批次進度」

### ⚠️ 執行時間限制說明

Google Apps Script 有以下執行時間限制：
- **免費版本**：6分鐘
- **Google Workspace**：30分鐘

#### 建議策略：
1. **小範圍資料**：使用一般爬取功能
2. **大範圍資料**：使用批次爬取功能
3. **定期更新**：設定每日自動爬取
4. **歷史補齊**：使用 Python 版本批量處理

### 資料存儲方式

所有契約的資料統一存儲在 **「所有期貨資料」** 工作表中，包含以下欄位：
- 日期
- 契約名稱
- 身份別（如果有）
- 多方交易口數/契約金額
- 空方交易口數/契約金額
- 多空淨額交易口數/契約金額
- 多方未平倉口數/契約金額
- 空方未平倉口數/契約金額
- 多空淨額未平倉口數/契約金額

### 安裝和設定

1. **複製代碼到 Google Apps Script**
   - 開啟 [Google Apps Script](https://script.google.com/)
   - 創建新專案
   - 將 Code.gs 和 chart.gs 的內容複製到對應文件

2. **設定試算表 ID**
   - 在 Code.gs 中修改 `SHEET_ID` 變數為您的 Google Sheet ID

3. **授權權限**
   - 首次執行時會要求授權
   - 允許腳本存取您的 Google Sheets

## Python 版本

### 功能特色
- **高效能批量爬取**：適合爬取大量歷史資料
- **多線程處理**：加速資料獲取
- **智能重試機制**：自動處理請求失敗
- **進度顯示**：實時顯示爬取進度
- **資料驗證**：自動檢查資料一致性

### 安裝要求
```bash
pip install -r requirements.txt
```

### 使用方式

#### 基本爬取
```bash
# 爬取最近30天的所有契約資料
python taifex_crawler.py

# 爬取指定日期範圍
python taifex_crawler.py --start-date 2024-01-01 --end-date 2024-01-31

# 爬取特定契約
python taifex_crawler.py --contracts TX TE --days 30
```

#### 身份別資料爬取
```bash
# 爬取身份別資料
python taifex_crawler.py --identities --contracts TX --days 7

# 爬取所有契約的身份別資料
python taifex_crawler.py --identities --days 30
```

#### 進階參數
```bash
# 調整線程數和延遲
python taifex_crawler.py --max-workers 5 --delay 1.0

# 設定輸出目錄
python taifex_crawler.py --output-dir ./my_data

# 設定超時時間
python taifex_crawler.py --timeout 60
```

### 輸出格式
- **CSV 檔案**：UTF-8 編碼，適合資料分析
- **Excel 檔案**：方便查看和分享
- **統一格式**：所有契約資料在同一個檔案中

## 資料欄位說明

| 欄位名稱 | 說明 |
|---------|------|
| 日期 | 交易日期 (YYYY/MM/DD) |
| 契約名稱 | 期貨契約代碼 (TX, TE, MTX, ZMX, NQF) |
| 身份別 | 交易者類型（自營商、投信、外資，或空白表示總計） |
| 多方交易口數 | 多方交易數量 |
| 多方契約金額 | 多方交易金額 |
| 空方交易口數 | 空方交易數量 |
| 空方契約金額 | 空方交易金額 |
| 多空淨額交易口數 | 多方減空方的交易數量 |
| 多空淨額契約金額 | 多方減空方的交易金額 |
| 多方未平倉口數 | 多方未平倉數量 |
| 多方未平倉契約金額 | 多方未平倉金額 |
| 空方未平倉口數 | 空方未平倉數量 |
| 空方未平倉契約金額 | 空方未平倉金額 |
| 多空淨額未平倉口數 | 多方減空方的未平倉數量 |
| 多空淨額未平倉契約金額 | 多方減空方的未平倉金額 |

## 注意事項

1. **交易日**：系統會自動跳過非交易日（週末和假日）
2. **資料來源**：資料來自台灣期貨交易所官方網站
3. **請求頻率**：自動控制請求頻率，避免對伺服器造成負擔
4. **錯誤處理**：遇到錯誤時會自動重試，並記錄詳細日誌
5. **執行時間**：Google Apps Script 版本受執行時間限制，大量資料建議使用 Python 版本

## 疑難排解

### Google Apps Script 版本

#### 執行時間超限
- **問題**：顯示「執行時間已達上限」，即使只爬取一天
- **解決方案**：
  1. **單日爬取**：使用「**快速爬取今日資料**」功能
  2. **多日爬取**：使用「批次爬取歷史資料」功能
  3. **檢查網路**：確保網路連線穩定
- **說明**：新版本已大幅優化性能，減少不必要的處理時間

#### 資料重複
- **問題**：相同日期的資料出現多次
- **解決**：系統有重複檢查機制，重複資料會自動跳過

#### 找不到資料
- **問題**：某些日期沒有資料
- **原因**：可能是非交易日或期交所網站問題
- **解決**：檢查是否為週末或假日

### Python 版本

#### 網路連線問題
```bash
# 增加重試次數和延遲時間
python taifex_crawler.py --max-retries 5 --delay 2.0
```

#### 記憶體不足
```bash
# 減少線程數
python taifex_crawler.py --max-workers 3
```

## 更新日誌

### v2.2.0 (最新)
- 🔄 **智能失敗重試系統**：
  - 每日自動爬取失敗時，自動重試最多3次，間隔10分鐘
  - 動態觸發器管理，精確控制重試時機
  - 詳細的重試日誌和狀態追蹤
- 📱 **雙重通知服務**：
  - 新增 Telegram Bot 整合，支援 HTML 格式訊息
  - 保持 LINE Notify 支援（免費，每小時1000則訊息）
  - 智能通知發送，可同時使用兩種服務
  - 包含數據摘要的豐富通知內容
- 🎯 **用戶體驗優化**：
  - 身份別資料爬取時，如沒有輸入契約名稱則預設為ALL
  - 改進的設置提示，清楚顯示通知服務狀態
  - 自動生成交易量和淨額數據摘要
- 📊 **系統功能增強**：
  - 統一的通知管理系統
  - 改進的錯誤處理和通知
  - 更完善的自動化流程管理

### v2.1.1
- 🛠️ 修正批次爬取邏輯：有失敗項目時保留進度記錄，不自動清除
- 📋 新增失敗項目詳細列表：顯示具體失敗的契約和日期
- 🔄 新增重試功能：「重試失敗的爬取項目」可自動重新嘗試失敗項目
- 🏢 完善身份別批次爬取：
  - 改進executeBatchIdentityFetch函數，添加詳細統計和失敗處理
  - 重試功能支援身份別資料的失敗項目
  - 更完善的身份別爬取進度管理
- 💡 改善用戶指引：提供明確的失敗處理建議和操作步驟
- 📊 完善失敗處理最佳實踐：系統化的失敗分析和重試流程

### v2.1.0
- 🚀 新增快速爬取功能：專為單日爬取優化，解決執行時間超限問題
- ⚡ 性能大幅優化：
  - 減少TX契約參數嘗試次數（從9次降至3次）
  - 簡化日誌記錄機制，提高執行效率
  - 添加請求超時控制（10秒）
  - 最小化延遲時間（200-300ms）
- 🔧 身份別爬取優化：優先使用最可能成功的方法
- 📝 簡化錯誤處理和日誌記錄

### v2.0.0
- ✅ 統一資料存儲：所有契約存在同一標籤頁
- ✅ 批次爬取功能：智能分批處理大範圍資料
- ✅ 執行時間管理：自動監控並避免超時
- ✅ 斷點續傳：支援中斷後繼續爬取
- ✅ 進度追蹤：實時保存和查看進度
- ✅ 圖表功能適配：支援從統一工作表生成圖表

### v1.0.0
- 基本爬取功能
- 多身份別支援
- 圖表生成
- 自動化排程

## 授權
本專案採用 MIT 授權條款。

## 貢獻
歡迎提交 Issue 和 Pull Request 來改善本工具。





